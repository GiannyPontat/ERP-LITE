#!/bin/bash

# Couleurs pour les messages
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üîç Pre-commit hooks - ERP LITE${NC}"
echo ""

# ============================================
# 1. V√©rification des fichiers sensibles
# ============================================
echo -e "${YELLOW}üìã V√©rification des fichiers sensibles...${NC}"

# V√©rifier si .env est dans les fichiers stag√©s
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo -e "${RED}‚ùå ERREUR: Fichier .env d√©tect√©${NC}"
    echo -e "${RED}   Annulez le commit de ce fichier avec: git reset HEAD .env${NC}"
    exit 1
fi

# V√©rifier les fichiers .key, .pem, .p12
if git diff --cached --name-only | grep -qE '\.(key|pem|p12)$'; then
    echo -e "${RED}‚ùå ERREUR: Fichier de certificat/cl√© d√©tect√©${NC}"
    echo -e "${RED}   Ces fichiers ne doivent pas √™tre commit√©s${NC}"
    exit 1
fi

# V√©rifier application.properties en production
if git diff --cached --name-only | grep -q "application-prod.properties"; then
    echo -e "${RED}‚ö†Ô∏è  ATTENTION: application-prod.properties d√©tect√©${NC}"
    read -p "√ätes-vous s√ªr de vouloir commiter ce fichier? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# V√©rifier les secrets dans le code
if git diff --cached | grep -qiE 'password.*=.*["\047][^"\047]{8,}'; then
    echo -e "${RED}‚ö†Ô∏è  ATTENTION: Possible secret d√©tect√© dans le code!${NC}"
    echo -e "${YELLOW}   V√©rifiez que vous ne committez pas de credentials.${NC}"
    read -p "Continuer quand m√™me? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo -e "${GREEN}‚úì Aucun fichier sensible d√©tect√©${NC}"
echo ""

# ============================================
# 2. Backend Java - V√©rifications
# ============================================
BACKEND_FILES=$(git diff --cached --name-only | grep "^backend/.*\.java$" | wc -l | tr -d ' ')

if [ "$BACKEND_FILES" -gt 0 ]; then
    echo -e "${YELLOW}‚òï Backend Java - V√©rification ($BACKEND_FILES fichiers)...${NC}"
    
    cd backend
    
    # Compilation rapide
    echo "  - Compilation du code..."
    if ./mvnw clean compile -q -DskipTests > /tmp/maven-compile.log 2>&1; then
        echo -e "${GREEN}  ‚úì Compilation r√©ussie${NC}"
    else
        echo -e "${RED}‚ùå La compilation a √©chou√©${NC}"
        tail -20 /tmp/maven-compile.log
        cd ..
        exit 1
    fi
    
    # Tests unitaires (optionnel - d√©commentez pour activer)
    # echo "  - Ex√©cution des tests..."
    # if ./mvnw test -q > /tmp/maven-test.log 2>&1; then
    #     echo -e "${GREEN}  ‚úì Tests r√©ussis${NC}"
    # else
    #     echo -e "${RED}‚ùå Les tests ont √©chou√©${NC}"
    #     tail -30 /tmp/maven-test.log
    #     cd ..
    #     exit 1
    # fi
    
    cd ..
    echo -e "${GREEN}‚úì Backend Java OK${NC}"
    echo ""
fi

# ============================================
# 3. Frontend Angular - V√©rifications
# ============================================
FRONTEND_FILES=$(git diff --cached --name-only | grep "^frontend/.*\.\(ts\|html\|scss\)$" | wc -l | tr -d ' ')

if [ "$FRONTEND_FILES" -gt 0 ]; then
    echo -e "${YELLOW}üÖ∞Ô∏è  Frontend Angular - V√©rification ($FRONTEND_FILES fichiers)...${NC}"
    
    cd frontend
    
    # V√©rifier que node_modules existe
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  node_modules non trouv√©, installation ignor√©e${NC}"
        cd ..
    else
        # Linting (d√©commentez pour activer)
        # echo "  - Linting du code..."
        # if npm run lint > /tmp/npm-lint.log 2>&1; then
        #     echo -e "${GREEN}  ‚úì Linting r√©ussi${NC}"
        # else
        #     echo -e "${RED}‚ùå Le linting a √©chou√©${NC}"
        #     cat /tmp/npm-lint.log
        #     cd ..
        #     exit 1
        # fi
        
        cd ..
        echo -e "${GREEN}‚úì Frontend Angular OK${NC}"
        echo ""
    fi
fi

# ============================================
# 4. V√©rification de la taille des fichiers
# ============================================
MAX_SIZE=5242880 # 5 MB
while IFS= read -r file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
        if [ "$size" -gt "$MAX_SIZE" ]; then
            echo -e "${RED}‚ö†Ô∏è  Fichier volumineux: $file ($((size / 1024 / 1024)) MB)${NC}"
            echo -e "${YELLOW}   Consid√©rez l'utilisation de Git LFS${NC}"
            read -p "Continuer quand m√™me? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi
    fi
done < <(git diff --cached --name-only)

echo -e "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
echo ""

exit 0
